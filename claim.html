<!DOCTYPE html>
<html>
<head>
  <title>Claim Item - Bravehearts Lost & Found</title>
  <link rel="stylesheet" type="text/css" href="lost.css">
  <style>
    body { font-family: Arial, sans-serif; background:#f2f2f2; margin:0; padding:0;}
    .video-background { position:fixed; top:0; left:0; width:100%; height:100%; z-index:-1; overflow:hidden; }
    .video-background video { width:100%; height:100%; object-fit:cover; }
    .card { background:rgba(255, 255, 255, 0.323); max-width:700px; margin:50px auto; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.2);}
    h2 { text-align:center; color:#13007d; }
    label { display:block; margin-top:12px; font-weight:bold; }
    input, select { width:100%; padding:8px; margin-top:4px; border-radius:6px; border:1px solid #ccc; }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    button { padding:12px 20px; margin-top:15px; border:none; border-radius:8px; background:#13007d; color:white; font-weight:bold; cursor:pointer; }
    button:disabled { background: #555; cursor: not-allowed; }
    .camera-container { display:flex; gap:10px; margin-top:15px; }
    .camera-left { flex:2; text-align:center; }
    .camera-right { flex:1; display:flex; flex-direction:column; gap:8px; align-items:flex-start; }
    #snapshot { display:none; }
    .preview img { max-width:220px; border:3px solid #13007d; border-radius:8px; margin-top:10px; }
    .locker-btn { flex:1; margin:2px; padding:8px; border-radius:6px; font-weight:bold; color:white; }
    #lockerInfo { margin-top:20px; background:rgba(255,255,255,0.6); padding:10px; border-radius:8px; display:none; }
    #photoWarning { color:red; text-align:center; margin-top:10px; display:none; font-weight:bold; }
    #otpDisplay { font-size: 40px; color: red; font-weight: bold; text-align:center; margin-top:10px; }
  </style>
</head>
<body>

<div class="video-background">
  <video autoplay muted loop playsinline>
    <source src="video/FAITH.mp4" type="video/mp4">
  </video>
</div>

<div class="card">
  <button id="backBtn">&larr; Back</button>
  <h2>Claim Your Locker Item</h2>
  <form id="claimForm">
    <label for="email">First Asia Email</label>
    <input id="email" name="email" type="email" placeholder="s20xxxxxxxx@firstasia.edu.ph" required />

    <div class="row">
      <div>
        <label for="name">Full Name</label>
        <input id="name" name="name" type="text" required />
      </div>
      <div>
        <label for="grade">Grade</label>
        <input id="grade" name="grade" type="text" required />
      </div>
      <div>
        <label for="section">Section</label>
        <input id="section" name="section" type="text" required />
      </div>
    </div>

    <label for="locker">Choose Your Locker</label>
    <div id="lockerContainer" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
    <input type="hidden" id="locker" name="locker">

    <div id="lockerInfo"></div>

    <!-- Camera & buttons layout -->
    <div class="camera-container">
      <!-- Left side: video + take picture -->
      <div class="camera-left">
        <video id="camera" autoplay playsinline style="width:100%; max-height:300px; border-radius:8px;"></video>
        <button type="button" id="takePic" style="margin-top:8px; padding:8px 16px; font-size:14px;">Take Picture</button>
      </div>
      <!-- Right side: switch cam + gallery -->
      <div class="camera-right">
        <button type="button" id="switchCam" style="padding:6px 12px; font-size:12px;">Switch Camera</button>
        <button type="button" id="selectGallery" style="padding:6px 12px; font-size:12px;">Select Gallery</button>
      </div>
    </div>

    <input type="file" id="galleryInput" accept="image/*" style="display:none;">
    <canvas id="snapshot"></canvas>
    <input type="hidden" id="photo_base64" name="photo_base64">
    <div class="preview" id="preview"></div>
    <p id="photoWarning">⚠️ Please take a picture before submitting.</p>

    <button type="submit" id="claimBtn">Claim Item</button>
  </form>

  <div id="summary" style="display:none;"></div>
  <div style="display:flex; justify-content:center; gap:15px; margin-top:10px;">
    <button id="submitAgain" style="display:none;">Claim Another Item</button>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxZqT3FEmc_MiBcgvIwGM48qLIu5NW6b3F8aBPstp92tw48-dbI_FM8SJ573rvPGTI5/exec";

const form = document.getElementById('claimForm');
const takePic = document.getElementById('takePic');
const snapshot = document.getElementById('snapshot');
const preview = document.getElementById('preview');
const photoBase64Input = document.getElementById('photo_base64');
const galleryInput = document.getElementById('galleryInput');
const photoWarning = document.getElementById('photoWarning');
const summary = document.getElementById('summary');
const submitAgain = document.getElementById('submitAgain');
const lockerContainer = document.getElementById('lockerContainer');
const lockerInput = document.getElementById('locker');
const lockerInfo = document.getElementById('lockerInfo');
const claimBtn = document.getElementById('claimBtn');

let allData = [];
let lockers = [];
let lockerSelected = null;

// Back button
document.getElementById('backBtn').addEventListener('click', () => window.history.back());

// Camera & Gallery
let currentStream = null;
let usingFrontCamera = true;
const camera = document.getElementById('camera');

async function initCamera() {
  if(currentStream) currentStream.getTracks().forEach(track => track.stop());
  try {
    currentStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: usingFrontCamera ? "user" : "environment" } });
    camera.srcObject = currentStream;
    camera.style.transform = usingFrontCamera ? 'scaleX(-1)' : 'scaleX(1)';
  } catch(err) {
    console.error("Camera error:", err);
    alert("Cannot access camera.");
  }
}
initCamera();

document.getElementById('switchCam').addEventListener('click', () => {
  usingFrontCamera = !usingFrontCamera;
  initCamera();
});

document.getElementById('selectGallery').addEventListener('click', () => galleryInput.click());
galleryInput.addEventListener('change', (e) => {
  const file = e.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(event){
    photoBase64Input.value = event.target.result;
    preview.innerHTML = `<img src="${event.target.result}" alt="Selected Image">`;
    photoWarning.style.display = "none";
  }
  reader.readAsDataURL(file);
});

takePic.addEventListener('click', () => {
  const ctx = snapshot.getContext('2d');
  snapshot.width = camera.videoWidth;
  snapshot.height = camera.videoHeight;
  if(usingFrontCamera){ ctx.translate(snapshot.width,0); ctx.scale(-1,1); }
  ctx.drawImage(camera,0,0);
  if(usingFrontCamera) ctx.setTransform(1,0,0,1,0,0);
  const dataUrl = snapshot.toDataURL('image/png');
  photoBase64Input.value = dataUrl;
  preview.innerHTML = `<img src="${dataUrl}" alt="Snapshot">`;
  photoWarning.style.display = "none";
});

// Fetch lockers
async function fetchLockers() {
  try {
    const res = await fetch(WEB_APP_URL);
    const data = await res.json();
    allData = data;

    lockers = Array.from({ length: 8 }, (_, i) => {
      const hasRecord = data.some(r => parseInt(r["Locker"]) === (i + 1));
      return { number: i + 1, claimable: hasRecord };
    });

    renderLockers();
  } catch(err) { console.error(err); }
}

function renderLockers() {
  lockerContainer.innerHTML = '';
  lockers.forEach((locker, i) => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = `Locker ${locker.number}`;
    btn.className = 'locker-btn';

    if (!locker.claimable) {
      btn.disabled = true;
      btn.style.background = '#555';
    } else {
      btn.disabled = false;
      btn.style.background = (lockerSelected === i ? '#28a745' : '#13007d');
    }

    btn.addEventListener('click', () => {
      if(!locker.claimable) return;
      lockerSelected = i;
      lockerInput.value = locker.number;
      renderLockers();
      showLockerInfo(locker.number);
    });

    lockerContainer.appendChild(btn);
  });
}

function showLockerInfo(lockerNum) {
  const info = allData.find(r => parseInt(r["Locker"]) === lockerNum);
  if (info) {
    lockerInfo.style.display = 'block';
    lockerInfo.innerHTML = `
      <h3>Locker ${lockerNum} Details</h3>
      <p><strong>What:</strong> ${info["What"] || "N/A"}</p>
      <p><strong>When:</strong> ${info["When"] || "N/A"}</p>
      <p><strong>Where:</strong> ${info["Where"] || "N/A"}</p>
      <p><strong>Who:</strong> ${info["Who"] || "N/A"}</p>
      <p><strong>Description:</strong> ${info["Description"] || "N/A"}</p>
      ${info["Photo"] ? `<img src="${info["Photo"]}" style="max-width:200px;border-radius:8px;">` : ""}
    `;
  }
}

// Initial fetch
fetchLockers();
setInterval(fetchLockers, 5000);

// Form submit
form.addEventListener('submit', async (e) => {
  e.preventDefault();
  if(!lockerInput.value) { alert("Please choose a locker!"); return; }
  if(!photoBase64Input.value) { photoWarning.style.display = "block"; return; }

  claimBtn.disabled = true;
  claimBtn.textContent = "Processing...";

  const fd = new FormData(form);
  const report = {};
  ['email','name','grade','section','photo_base64','locker'].forEach(k => report[k] = fd.get(k) || '');
  report.claim = "true";

  try {
    const res = await fetch(WEB_APP_URL, { method:"POST", body: new URLSearchParams(report) });
    const result = await res.json();
    const otp = result.otp || "N/A";

    lockers.find(l => l.number == report.locker).claimable = false;
    renderLockers();

    form.style.display = 'none';
    preview.innerHTML = '';
    summary.style.display = 'block';
    summary.innerHTML = `
      <h2>Claim Summary</h2>
      <ul>
        <li><strong>Email:</strong> ${report.email}</li>
        <li><strong>Name:</strong> ${report.name}</li>
        <li><strong>Grade:</strong> ${report.grade}</li>
        <li><strong>Section:</strong> ${report.section}</li>
        <li><strong>Locker:</strong> ${report.locker}</li>
        <li><strong>Photo:</strong><br><img src="${report.photo_base64}" style="max-width:300px;border:2px solid #13007d;border-radius:8px;"></li>
      </ul>
      <p style='color:green;font-weight:bold;'>Your claim has been submitted. Thank you!</p>
      <p style='color:red;font-weight:bold;text-align:center;'>Open Locker ${report.locker} and place the item inside. Thank you!</p>
      <div id="otpDisplay">OTP: ${otp}</div>
    `;
    submitAgain.style.display = 'inline-block';
  } catch(err) {
    alert("Error processing claim: "+err);
    claimBtn.disabled=false;
    claimBtn.textContent="Claim Item";
  }
});

submitAgain.addEventListener('click', ()=>window.location.reload());
</script>
</body>
</html>

