<!DOCTYPE html>
<html>
<head>
  <title>Found Items - Bravehearts Lost & Found</title>
  <link rel="stylesheet" type="text/css" href="lost.css">
  <style>
    body { font-family: Arial, sans-serif; background:#f2f2f2; margin:0; padding:0;}
    .video-background { position:fixed; top:0; left:0; width:100%; height:100%; z-index:-1; overflow:hidden; }
    .video-background video { width:100%; height:100%; object-fit:cover; }
    .card { background:rgba(255, 255, 255, 0.323); max-width:600px; margin:50px auto; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.2);}
    h2 { text-align:center; color:#13007d; }
    label { display:block; margin-top:12px; font-weight:bold; }
    input, textarea { width:100%; padding:8px; margin-top:4px; border-radius:6px; border:1px solid #ccc; }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    button { padding:12px 20px; margin-top:15px; border:none; border-radius:8px; background:#13007d; color:white; font-weight:bold; cursor:pointer; }
    button:disabled { background: #555; cursor: not-allowed; }
    .camera-container { margin-top:15px; text-align:center; }
    #snapshot { display:none; }
    .preview img { max-width:220px; border:3px solid #13007d; border-radius:8px; margin-top:10px; }
    #summary { text-align:left; margin-top:20px; }
    .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #13007d; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; vertical-align: middle; margin-left: 10px; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .locker-btn { flex:1; margin:2px; padding:8px; border-radius:6px; font-weight:bold; color:white; }
  </style>
</head>
<body>

<div class="video-background">
  <video autoplay muted loop playsinline>
    <source src="video/FAITH.mp4" type="video/mp4">
  </video>
</div>

<div class="card">
  <button id="backBtn">&larr; Back</button>
  <h2>Found Item Report</h2>
  <form id="lostForm">
    <label for="email">First Asia Email</label>
    <input id="email" name="email" type="email" placeholder="s20xxxxxxxx@firstasia.edu.ph" required />
    <div class="row">
      <div>
        <label for="what">What (Anong nahanap?)</label>
        <input id="what" name="what" type="text" placeholder="Ex: wallet, phone" required />
      </div>
      <div>
        <label for="when">When (Kailan nahanap?)</label>
        <input id="when" name="when" type="datetime-local" required />
      </div>
    </div>
    <div class="row">
      <div>
        <label for="where">Where (Saan nahanap?)</label>
        <input id="where" name="where" type="text" placeholder="Ex: 3rd floor hallway" />
      </div>
      <div>
        <label for="who">Who (Kung kilala ang may-ari)</label>
        <input id="who" name="who" type="text" placeholder="Optional" />
      </div>
    </div>
    <label for="otherw">More Info</label>
    <input id="otherw" name="otherw" type="text" placeholder="Ex: Contains an ID card inside" />
    <label for="description">Description (Detalye)</label>
    <textarea id="description" name="description" rows="4" placeholder="Unique characteristics of the item (color, brand, damage, etc.)"></textarea>

    <label for="locker">Choose a Locker (Only 1 per report)</label>
    <div id="lockerContainer" style="display:flex; flex-wrap:wrap; gap:5px;"></div>
    <input type="hidden" id="locker" name="locker">

    <div class="camera-container">
      <video id="camera" autoplay playsinline></video>
    </div>
    <button type="button" id="takePic">Take Picture</button>
    <canvas id="snapshot"></canvas>
    <input type="hidden" id="photo_base64" name="photo_base64">
    <div class="preview" id="preview"></div>

    <button type="submit">Send Report</button>
  </form>

  <div id="summary" style="display:none;"></div>
  <div style="display:flex; justify-content:center; gap:15px; margin-top:10px;">
    <button id="submitAgain" style="display:none;">Submit Another Report</button>
    <button id="viewReports" style="display:none;">View All Reports</button>
  </div>
</div>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby6dvb5Bj1cHNIzhbF_b0SrhAIth3yiCerAb3m3EJUNvg84xgRTTuoQyxnPu-rXyA4-/exec"; // Replace with your deployed Apps Script URL

const form = document.getElementById('lostForm');
const camera = document.getElementById('camera');
const takePic = document.getElementById('takePic');
const snapshot = document.getElementById('snapshot');
const preview = document.getElementById('preview');
const photoBase64Input = document.getElementById('photo_base64');
const summary = document.getElementById('summary');
const submitAgain = document.getElementById('submitAgain');
const viewReports = document.getElementById('viewReports');
const backBtn = document.getElementById('backBtn');
const lockerContainer = document.getElementById('lockerContainer');
const lockerInput = document.getElementById('locker');

backBtn.addEventListener('click', () => window.history.back());

// Camera
async function initCamera() {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    camera.srcObject = stream;
  } catch(err) {
    console.error("Camera error:", err);
  }
}
initCamera();

takePic.addEventListener('click', () => {
  const ctx = snapshot.getContext('2d');
  snapshot.width = camera.videoWidth;
  snapshot.height = camera.videoHeight;
  ctx.drawImage(camera, 0, 0);
  const dataUrl = snapshot.toDataURL('image/png');
  photoBase64Input.value = dataUrl;
  preview.innerHTML = `<img src="${dataUrl}" alt="Snapshot">`;
});

// Locker system
let lockers = [];
let lockerSelected = null;

async function fetchLockers() {
  try {
    const res = await fetch(WEB_APP_URL);
    const data = await res.json();

    const usedLockers = data
      .map(r => r["Locker"] ? parseInt(r["Locker"]) : null)
      .filter(n => n >= 1 && n <= 8);

    lockers = Array.from({ length: 8 }, (_, i) => ({
      number: i + 1,
      available: !usedLockers.includes(i + 1)
    }));

    if(lockerSelected !== null && !lockers[lockerSelected].available) {
      lockerSelected = null;
      lockerInput.value = '';
    }

    renderLockers();
  } catch(err) {
    console.error("Locker fetch error:", err);
    lockers = Array.from({ length: 8 }, (_, i) => ({ number: i + 1, available: true }));
    renderLockers();
  }
}

function renderLockers() {
  lockerContainer.innerHTML = '';
  lockers.forEach((locker, i) => {
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = `Locker ${locker.number}`;
    btn.className = 'locker-btn';
    btn.disabled = !locker.available;
    btn.style.background = locker.available ? (lockerSelected === i ? '#28a745' : '#13007d') : '#555';
    btn.addEventListener('click', () => {
      if(!locker.available) return;
      lockerSelected = i;
      lockerInput.value = locker.number;
      renderLockers();
    });
    lockerContainer.appendChild(btn);
  });
}

fetchLockers();
setInterval(fetchLockers, 5000);

// Submit
form.addEventListener('submit', (e) => {
  e.preventDefault();
  if(!lockerInput.value) return alert("Please choose a locker!");

  const submitButton = form.querySelector('button[type="submit"]');
  submitButton.disabled = true;
  submitButton.textContent = "Sending...";

  const fd = new FormData(form);
  const report = {};
  ['email','what','when','where','who','otherw','description','photo_base64','locker'].forEach(k => report[k] = fd.get(k) || '');

  fetch(WEB_APP_URL, { method:"POST", body: new URLSearchParams(report) })
    .then(r => r.text())
    .then(() => {
      form.style.display='none';
      preview.innerHTML='';
      summary.style.display='block';
      summary.innerHTML = "<h2>Report Summary</h2><ul>" +
        Object.keys(report).map(k => k==='photo_base64'?`<li><strong>Photo:</strong><br><img src="${report[k]}" style="max-width:300px;border:2px solid #13007d;border-radius:8px;"></li>`:`<li><strong>${k}:</strong> ${report[k]}</li>`).join('') +
        `</ul><p style='color:green;font-weight:bold;'>Report sent. Thank you!</p>` +
        `<p style='color:red;font-weight:bold;'>Please get the RFID key for Locker ${lockerInput.value} and place your item inside.</p>`;

      submitAgain.style.display='inline-block';
      viewReports.style.display='inline-block';
    })
    .catch(err => {
      alert("Error sending report: "+err);
      submitButton.disabled=false;
      submitButton.textContent="Send Report";
    });
});

submitAgain.addEventListener('click', ()=>window.location.reload());
viewReports.addEventListener('click', ()=>window.location.href='foundreport.html');
</script>
</body>
</html>
